# RFC 031: Relation Batcher

## Background

The `relation_embedder` was recently introduced into the pipeline to denormalise related works into a works data, so that a particular work in an archive retrieved from the API will contain it's children, ancestors and siblings.

## Problem

Currently the `relation_embedder` is not processing works at a rate that is sufficient, being orders of magnitude slower than other pipeline stages.

There has already been a number of PRs which have attempted to allieviate this by optimising the requests sent to Elasticsearch for indexing, retrieval and querying of relations:

* [#1007 Try to make the relation embedder more efficient](https://github.com/wellcomecollection/catalogue/pull/1007)
* [#1011 Don't index unnecessary fields in pipeline storage](https://github.com/wellcomecollection/catalogue/pull/1011)
* [#1017 Use scroll API and return works directly in the getAffectedWorks query](https://github.com/wellcomecollection/catalogue/pull/1017)
* [#1018 Cache all relations for an archive up front of denormalising](https://github.com/wellcomecollection/catalogue/pull/1018)

This work is definately useful (and with [#1011](https://github.com/wellcomecollection/catalogue/pull/1011) greatly improves pipeline storage indexing performance for other services too), but is unlikely on its own to make a significant enough improvement to throughput, due to more fundamental problems with the work performed by the `relation_embedder`.

The main issue is that for a single input to the `relation_embedder`, it can result in many works being denormalised. Given the following tree:

```
A
|-----
|    |
B    C
|    |-----
|    |    |
D    E    F
```

When a message is received for work `D` it will need denormalise 2 works, namely `B` and `D`: it needs to denormalise the work itself, and it's parent `B` due to it needing to update it's `children` field. When a message is received for work `A` however it will need to denormalise every work in the tree, due to all of the works containing `A` as an ancestor.

When building the `relation_embedder` the assumpion was made that many more works will be further down the tree and leaf nodes than being near the root, so the amount of work performed will be managable. However this assumpion doesn't really hold, with a combinatorially large amount of work being generated by nodes that are high in the tree of large archives.

There are also extreme cases where even though most of the works in an archive are leaf nodes, the archive is very flat. To take one real world example:

```
MS9225
|
|---
|  |
1  2
   |-------------
   |  |  |      |
   1  2  3 ... 3583
```

There are 3583 works here which are siblings of eachother, and when any one of these is received at the input it will result in all of their siblings and the two ancestors needing to be denormalised too. For an initial reindex that will result in denormalising 6,427,905 works (`1 + 2 + ... + 3585`), and in a reharvest where in the worst case all of the works in the archive are sent again it will result in 12,852,225 (`3585 * 3585`). In an ideal scenario, we would of course only denormalise each of the works in that archive one time only (i.e. 3,585 denormalisations), with anything above that being unnecessary work. Note this is just a single archive, and there will likely be other similar cases out of the 6349 archives currently in Calm.

## Proposed Solution

## Potential Issues
